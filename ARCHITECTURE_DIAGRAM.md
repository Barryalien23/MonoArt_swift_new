# ğŸ—ï¸ MonoArt GPU Preview â€” ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°

## ğŸ“ ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MonoArt App                                  â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   ContentView                                   â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚            AsciiCameraExperience                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  State:                                                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ @StateObject viewModel: AppViewModel                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ @State gpuPipeline: GPUPreviewPipeline?                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ @State textPipeline: PreviewPipeline?                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ @State useGPUPreview: Bool = true                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  startPipelineIfNeeded()                             â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  if useGPUPreview && engine is AsciiEngine   â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚   Create GPUPreviewPipeline          â”‚    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ AsciiEngine (GPU methods)        â”‚    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ CameraService                    â”‚    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ MediaCoordinator                 â”‚    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ AsciiFrameRenderer               â”‚    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  else                                         â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚   Create PreviewPipeline (Fallback)  â”‚    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ AsciiEngineProtocol (CPU path)   â”‚    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ CameraService                    â”‚    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â”‚   â€¢ Text rendering                   â”‚    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚              RootView                                â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                                       â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  if useGPUPreview && engine != nil:                  â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚         MetalPreviewView                      â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚         (GPU 60 FPS)                          â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ MTKView                                    â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ AsciiEngine.draw(in:)                      â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ Real-time preview                          â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  else:                                                â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚    CameraPreviewContainer                     â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚    (Text fallback)                            â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ Text(glyphText)                            â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  â€¢ CPU rendering                              â”‚   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚                                                       â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ ControlOverlay (buttons)                          â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ SettingsHandle                                    â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  â€¢ CaptureConfirmationBanner                         â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (GPU Preview)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Camera     â”‚
â”‚   Hardware   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ CVPixelBuffer (BGRA)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CameraService         â”‚
â”‚   (AVCaptureSession)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ FrameEnvelope
       â”‚ framePublisher
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GPUPreviewPipeline         â”‚
â”‚                              â”‚
â”‚   1. Receive frame           â”‚
â”‚   2. Convert to MTLTexture   â”‚
â”‚      (CVMetalTextureCache)   â”‚
â”‚   3. Update engine           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ MTLTexture
       â”‚ engine.updatePreviewVideoTexture(texture)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AsciiEngine                         â”‚
â”‚   (GPU Preview State)                 â”‚
â”‚                                       â”‚
â”‚   â€¢ currentVideoTexture: MTLTexture?  â”‚
â”‚   â€¢ previewPipelineState              â”‚
â”‚   â€¢ glyphAtlas: GlyphAtlas            â”‚
â”‚   â€¢ PreviewUniforms                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ MTKViewDelegate
       â”‚ draw(in view: MTKView)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Metal Rendering Pipeline             â”‚
â”‚                                        â”‚
â”‚   1. Encode render pass                â”‚
â”‚   2. Set textures:                     â”‚
â”‚      â€¢ videoTexture (BGRA)             â”‚
â”‚      â€¢ atlasTexture (r8Unorm)          â”‚
â”‚   3. Set uniforms (parameters)         â”‚
â”‚   4. Draw fullscreen triangle (3 verts)â”‚
â”‚   5. Fragment shader:                  â”‚
â”‚      â€¢ aspect-fill video               â”‚
â”‚      â€¢ luminance calculation           â”‚
â”‚      â€¢ glyph atlas lookup              â”‚
â”‚      â€¢ color mixing                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 60 FPS
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MTKView â”‚
    â”‚ Display â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš™ï¸ ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      AppViewModel          â”‚
â”‚                            â”‚
â”‚  @Published properties:    â”‚
â”‚  â€¢ selectedEffect          â”‚
â”‚  â€¢ parameters              â”‚
â”‚  â€¢ palette                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Combine Publishers
       â”‚ .merge() + .debounce(16ms)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GPUPreviewPipeline             â”‚
â”‚   observeViewModelChanges()      â”‚
â”‚                                  â”‚
â”‚   Publishers.Merge3(             â”‚
â”‚     effectPublisher,             â”‚
â”‚     parameterPublisher,          â”‚
â”‚     palettePublisher             â”‚
â”‚   )                              â”‚
â”‚   .debounce(16ms)                â”‚
â”‚   .sink { _ in                   â”‚
â”‚     engine.updatePreviewParameters()
â”‚   }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Update GPU state
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AsciiEngine                      â”‚
â”‚   updatePreviewParameters(         â”‚
â”‚     parameters,                    â”‚
â”‚     palette,                       â”‚
â”‚     effect                         â”‚
â”‚   )                                â”‚
â”‚                                    â”‚
â”‚   â€¢ Regenerate atlas if effect changed
â”‚   â€¢ Update PreviewUniforms         â”‚
â”‚   â€¢ Next draw() uses new settings  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¸ Capture Flow (CPU Path)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User      â”‚
â”‚   Taps      â”‚
â”‚   Capture   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AsciiCameraExperience   â”‚
â”‚  captureTapped()         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GPUPreviewPipeline             â”‚
â”‚   capture()                      â”‚
â”‚                                  â”‚
â”‚   1. Get latestFrame             â”‚
â”‚   2. Call engine.renderCapture() â”‚
â”‚      (CPU path for quality)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ pixelBuffer
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AsciiEngine                      â”‚
â”‚   renderCapture()                  â”‚
â”‚                                    â”‚
â”‚   â€¢ Compute luminance (GPU/CPU)    â”‚
â”‚   â€¢ Map to glyphs (CPU)            â”‚
â”‚   â€¢ Build AsciiFrame with glyphTextâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ AsciiFrame
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AsciiFrameRenderer               â”‚
â”‚   makeImage(from:palette:)         â”‚
â”‚                                    â”‚
â”‚   â€¢ Render text to UIImage         â”‚
â”‚   â€¢ Apply palette colors           â”‚
â”‚   â€¢ High quality output            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ UIImage
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PhotosMediaCoordinator           â”‚
â”‚   save(image:)                     â”‚
â”‚                                    â”‚
â”‚   â€¢ Request Photos permission      â”‚
â”‚   â€¢ Save to Photo Library          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Photos â”‚
  â”‚ Saved! â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”€ Fallback Mechanism

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AsciiCameraExperience       â”‚
â”‚  startPipelineIfNeeded()     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ useGPUPreview == true?    â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚ Yes               â”‚ No
       â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ engine is       â”‚  â”‚ Create           â”‚
â”‚ AsciiEngine?    â”‚  â”‚ PreviewPipeline  â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚ (Text fallback)  â”‚
  â”‚ Yes       â”‚ No   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create  â”‚ â”‚ Create           â”‚
â”‚ GPU     â”‚ â”‚ PreviewPipeline  â”‚
â”‚ Pipelineâ”‚ â”‚ (Text fallback)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ ĞœĞ¾Ğ´ÑƒĞ»Ğ¸ Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AsciiCameraKit                          â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              AsciiCameraKit (main)                   â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  â€¢ AsciiCameraExperience                            â”‚  â”‚
â”‚  â”‚  â€¢ GPUPreviewPipeline                               â”‚  â”‚
â”‚  â”‚  â€¢ PreviewPipeline                                  â”‚  â”‚
â”‚  â”‚  â€¢ GPUPreviewCoordinator                            â”‚  â”‚
â”‚  â”‚  â€¢ AsciiFrameRenderer                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                            â”‚                     â”‚
â”‚         â–¼                            â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   AsciiUI      â”‚          â”‚   AsciiEngine    â”‚         â”‚
â”‚  â”‚                â”‚          â”‚                  â”‚         â”‚
â”‚  â”‚  â€¢ RootView    â”‚          â”‚  â€¢ AsciiEngine   â”‚         â”‚
â”‚  â”‚  â€¢ MetalPreviewâ”‚          â”‚  â€¢ GlyphAtlas    â”‚         â”‚
â”‚  â”‚  â€¢ Controls    â”‚          â”‚  â€¢ Shaders       â”‚         â”‚
â”‚  â”‚  â€¢ Settings    â”‚          â”‚  â€¢ GPU Preview   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚                         â”‚                     â”‚
â”‚           â–¼                         â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚            AsciiDomain                        â”‚        â”‚
â”‚  â”‚                                               â”‚        â”‚
â”‚  â”‚  â€¢ AppViewModel                               â”‚        â”‚
â”‚  â”‚  â€¢ EffectType, EffectParameters               â”‚        â”‚
â”‚  â”‚  â€¢ PaletteState, PreviewFrame                 â”‚        â”‚
â”‚  â”‚  â€¢ PreviewStatus, CaptureStatus               â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                          â”‚                                â”‚
â”‚                          â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚            AsciiCamera                        â”‚        â”‚
â”‚  â”‚                                               â”‚        â”‚
â”‚  â”‚  â€¢ CameraService                              â”‚        â”‚
â”‚  â”‚  â€¢ FrameEnvelope                              â”‚        â”‚
â”‚  â”‚  â€¢ AVCaptureSession wrapper                   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ĞºĞ»Ğ°ÑÑÑ‹ Ğ¸ Ğ¸Ñ… Ñ€Ğ¾Ğ»Ğ¸

### 1. **GPUPreviewPipeline**
**Ğ Ğ¾Ğ»ÑŒ:** ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€ GPU-Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³Ğ°
- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ĞºĞ°Ğ´Ñ€Ñ‹ Ğ¾Ñ‚ CameraService
- ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ CVPixelBuffer â†’ MTLTexture
- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ AsciiEngine
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ capture Ñ‡ĞµÑ€ĞµĞ· CPU path

### 2. **AsciiEngine** (Ñ GPU Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°Ğ¼Ğ¸)
**Ğ Ğ¾Ğ»ÑŒ:** ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ´Ğ²Ğ¸Ğ¶Ğ¾Ğº Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³Ğ°
- `setupPreview(on:effect:)` â€” Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Metal
- `updatePreviewVideoTexture(_:)` â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ´Ñ€Ğ°
- `updatePreviewParameters(_:palette:effect:)` â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº
- `draw(in:)` â€” MTKViewDelegate Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³
- `renderCapture(...)` â€” CPU path Ğ´Ğ»Ñ capture

### 3. **MetalPreviewView**
**Ğ Ğ¾Ğ»ÑŒ:** SwiftUI Ğ¾Ğ±Ñ‘Ñ€Ñ‚ĞºĞ° Ğ´Ğ»Ñ MTKView
- UIViewRepresentable Ğ´Ğ»Ñ MTKView
- Ğ¡Ğ²ÑĞ·ÑŒ SwiftUI â†” Metal
- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ refresh (CADisplayLink)

### 4. **RootView**
**Ğ Ğ¾Ğ»ÑŒ:** Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ UI ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚
- Ğ£ÑĞ»Ğ¾Ğ²Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³ GPU/Text preview
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ overlay (ĞºĞ½Ğ¾Ğ¿ĞºĞ¸, Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸)
- ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° user actions

### 5. **AsciiCameraExperience**
**Ğ Ğ¾Ğ»ÑŒ:** Top-level ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€
- Ğ’Ñ‹Ğ±Ğ¾Ñ€ GPU vs Text pipeline
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ lifecycle (start/stop)
- ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° capture, flip, import

## ğŸ”§ Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸

### Metal Rendering
```
Vertex Shader (previewVS)
   â”‚
   â–¼ Fullscreen triangle (3 vertices)
   â”‚
   â–¼
Fragment Shader (previewFS)
   â”‚
   â”œâ”€â†’ Sample video texture (BGRA)
   â”œâ”€â†’ Calculate luminance
   â”œâ”€â†’ Map to glyph index
   â”œâ”€â†’ Sample atlas texture (r8)
   â”œâ”€â†’ Apply edge/soft/jitter
   â”œâ”€â†’ Mix colors (colorA/colorB)
   â”‚
   â–¼
Output (BGRA8Unorm)
```

### Texture Flow
```
Camera â†’ CVPixelBuffer (BGRA)
   â”‚
   â–¼ CVMetalTextureCacheCreateTextureFromImage()
   â”‚
   â–¼ CVMetalTexture
   â”‚
   â–¼ CVMetalTextureGetTexture()
   â”‚
   â–¼ MTLTexture (bgra8Unorm)
   â”‚
   â–¼ engine.updatePreviewVideoTexture()
   â”‚
   â–¼ Fragment shader texture binding
```

### Glyph Atlas
```
EffectType.characterSet
   â”‚
   â–¼ GlyphAtlas.make()
   â”‚
   â”œâ”€â†’ Create CGContext (Gray, 8bpc)
   â”œâ”€â†’ Draw characters with UIFont
   â”œâ”€â†’ Extract pixel data
   â”‚
   â–¼ MTLTexture (r8Unorm)
   â”‚
   â–¼ Fragment shader atlas lookup
```

---

**Ğ’ĞµÑ€ÑĞ¸Ñ:** 0.2.0  
**Ğ”Ğ°Ñ‚Ğ°:** 8 Ğ½Ğ¾ÑĞ±Ñ€Ñ 2025  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Production Ready

